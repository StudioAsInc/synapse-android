<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse Presence System - Integration Example</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6B4CFF 0%, #8B5CF6 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .status-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #6B4CFF;
        }

        .status-card h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            transition: background 0.3s ease;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .user-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .user-list h3 {
            margin: 0 0 20px 0;
            color: #333;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6B4CFF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 0.9em;
            color: #666;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.online { background: #28a745; }
        .status-dot.away { background: #ffc107; }
        .status-dot.busy { background: #dc3545; }
        .status-dot.offline { background: #6c757d; }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .control-group h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .btn {
            background: #6B4CFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a3fd8;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .activity-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .logs h3 {
            margin: 0 0 15px 0;
            color: #fff;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-time {
            color: #888;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .status-section,
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Synapse Presence System</h1>
            <p>Real-time user presence tracking with Firebase</p>
        </div>

        <div class="content">
            <!-- Connection Status -->
            <div class="status-section">
                <div class="status-card">
                    <h3>Connection Status</h3>
                    <div class="connection-status">
                        <div class="status-indicator" id="connection-indicator"></div>
                        <span id="connection-text">Disconnected</span>
                    </div>
                    <p>Current User: <strong id="current-user">Not initialized</strong></p>
                </div>

                <div class="status-card">
                    <h3>Current Activity</h3>
                    <p>Activity: <strong id="current-activity">None</strong></p>
                    <p>Status: <strong id="current-status">Offline</strong></p>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <h3>User Management</h3>
                    <button class="btn" onclick="initializePresence()">Initialize Presence</button>
                    <button class="btn secondary" onclick="cleanupPresence()">Cleanup</button>
                    <br>
                    <input type="text" id="user-id" class="activity-input" placeholder="User ID" value="user123">
                    <input type="text" id="user-name" class="activity-input" placeholder="Display Name" value="John Doe">
                </div>

                <div class="control-group">
                    <h3>Activity & Status</h3>
                    <input type="text" id="activity-input" class="activity-input" placeholder="Activity (e.g., typing, viewing_profile)">
                    <button class="btn" onclick="updateActivity()">Update Activity</button>
                    <br>
                    <button class="btn" onclick="setStatus('online')">Set Online</button>
                    <button class="btn" onclick="setStatus('away')">Set Away</button>
                    <button class="btn" onclick="setStatus('busy')">Set Busy</button>
                    <button class="btn secondary" onclick="setStatus('offline')">Set Offline</button>
                </div>
            </div>

            <!-- User List -->
            <div class="user-list">
                <h3>Online Users</h3>
                <div id="users-container">
                    <p>No users online</p>
                </div>
            </div>

            <!-- Logs -->
            <div class="logs">
                <h3>System Logs</h3>
                <div id="logs-container"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Presence System -->
    <script src="firebase-presence.js"></script>

    <script>
        // Global variables
        let presenceSystem = null;
        let currentUserId = 'user123';
        let currentUserName = 'John Doe';

        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Logging function
        function log(message) {
            const logsContainer = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span>${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Initialize presence system
        function initializePresence() {
            try {
                currentUserId = document.getElementById('user-id').value || 'user123';
                currentUserName = document.getElementById('user-name').value || 'John Doe';

                // Initialize presence system
                presenceSystem = new FirebasePresenceSystem({
                    databaseURL: firebaseConfig.databaseURL,
                    presencePath: 'presence',
                    userStatusPath: 'user_status',
                    connectionTimeout: 30000,
                    heartbeatInterval: 25000
                });

                // Initialize for current user
                const userData = {
                    id: currentUserId,
                    displayName: currentUserName,
                    username: currentUserId,
                    avatarUrl: `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserName)}&background=6B4CFF&color=fff`,
                    platform: 'web'
                };

                presenceSystem.initializeUserPresence(currentUserId, userData);

                // Set up connection monitoring
                presenceSystem.onConnectionChange((isConnected) => {
                    updateConnectionUI(isConnected);
                    log(`Connection status: ${isConnected ? 'Connected' : 'Disconnected'}`);
                });

                // Set up activity tracking
                setupActivityTracking();

                // Update UI
                document.getElementById('current-user').textContent = currentUserName;
                log(`Presence system initialized for user: ${currentUserName} (${currentUserId})`);

            } catch (error) {
                log(`Error initializing presence: ${error.message}`);
                console.error('Presence initialization error:', error);
            }
        }

        // Setup activity tracking
        function setupActivityTracking() {
            // Track page visibility
            document.addEventListener('visibilitychange', () => {
                if (presenceSystem) {
                    if (document.hidden) {
                        presenceSystem.setUserStatus('away');
                        log('Page hidden - status set to away');
                    } else {
                        presenceSystem.setUserStatus('online');
                        log('Page visible - status set to online');
                    }
                }
            });

            // Track user activity
            let activityTimeout;
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];

            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    if (presenceSystem && presenceSystem.isUserConnected()) {
                        clearTimeout(activityTimeout);
                        activityTimeout = setTimeout(() => {
                            presenceSystem.updateActivity('idle');
                            document.getElementById('current-activity').textContent = 'idle';
                        }, 30000); // 30 seconds of inactivity
                    }
                });
            });
        }

        // Update connection UI
        function updateConnectionUI(isConnected) {
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');

            if (isConnected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator';
                text.textContent = 'Disconnected';
            }
        }

        // Update activity
        function updateActivity() {
            if (!presenceSystem) {
                log('Presence system not initialized');
                return;
            }

            const activity = document.getElementById('activity-input').value;
            if (activity.trim()) {
                presenceSystem.updateActivity(activity);
                document.getElementById('current-activity').textContent = activity;
                log(`Activity updated: ${activity}`);
            }
        }

        // Set user status
        function setStatus(status) {
            if (!presenceSystem) {
                log('Presence system not initialized');
                return;
            }

            presenceSystem.setUserStatus(status);
            document.getElementById('current-status').textContent = status;
            log(`Status set to: ${status}`);
        }

        // Cleanup presence system
        function cleanupPresence() {
            if (presenceSystem) {
                presenceSystem.cleanup();
                presenceSystem = null;
                updateConnectionUI(false);
                document.getElementById('current-user').textContent = 'Not initialized';
                document.getElementById('current-activity').textContent = 'None';
                document.getElementById('current-status').textContent = 'Offline';
                log('Presence system cleaned up');
            }
        }

        // Get online users
        function getOnlineUsers() {
            if (!presenceSystem) {
                log('Presence system not initialized');
                return;
            }

            presenceSystem.getOnlineUsers((onlineUsers) => {
                const container = document.getElementById('users-container');
                
                if (onlineUsers.length === 0) {
                    container.innerHTML = '<p>No users online</p>';
                    return;
                }

                container.innerHTML = '';
                onlineUsers.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.innerHTML = `
                        <div class="user-avatar">${user.display_name ? user.display_name.charAt(0).toUpperCase() : 'U'}</div>
                        <div class="user-info">
                            <div class="user-name">${user.display_name || 'Unknown User'}</div>
                            <div class="user-status">
                                <span class="status-dot ${user.status}"></span>
                                ${user.status} - Last seen: ${new Date(user.last_seen).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                    container.appendChild(userElement);
                });

                log(`Found ${onlineUsers.length} online users`);
            });
        }

        // Auto-refresh online users every 10 seconds
        setInterval(() => {
            if (presenceSystem) {
                getOnlineUsers();
            }
        }, 10000);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('Page loaded - ready to initialize presence system');
            
            // Auto-initialize after 2 seconds (for demo purposes)
            setTimeout(() => {
                if (!presenceSystem) {
                    log('Auto-initializing presence system...');
                    initializePresence();
                }
            }, 2000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (presenceSystem) {
                presenceSystem.cleanup();
            }
        });
    </script>
</body>
</html>